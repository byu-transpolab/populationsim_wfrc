---
title: "Household Coordinates"
author: "Chris Day"
date: "6/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rmarkdown)
library(sf)
library(leaflet)
library(leafsync)
library(tidyverse)
library(kableExtra)
```


### Introduction
As a result of the synthetic population analysis, a certain number of households exist within each TAZ. Each one of those households were assigned the same position as the centroid of the TAZ in which they reside in. For exampe, if a TAZ were to have 2000 households, all 2000 would be located in the exact same spot. Of course this is unrealistic, and to help reduce further error in future analyses, new geographic coordinates will be assigned to each household id.


### Parcel IDs
The new coordinates for the households are based on the parcels within the same TAZ. The parcel datasets were found on AGRC (https://gis.utah.gov/data/cadastre/parcels/). All five counties of interest and their parcel information was then uploaded into QGIS, where they were joined and then their centroids were found. A joint analysis was run between the WFRC GIS TAZ file and the parcel centroids, creating a list of parcel coordninates at the TAZ level.

The coordinate system (CRS) that was used in the GIS calculation of the latitude and longitude points was WGS 84. Both the TAZ centroids and parcel centroids are in the same coordinate system.

```{r files}
#the synthetic population and parcel datasets are read into the file
house <- read_csv("output/synthetic_households.csv") 
parcel <- read_csv("inputs/parcel2.csv")
  colnames(parcel)[1] <- "TAZ"
  
#read and filter the taz centroid dataset to be in the correct format
tazcent <- read_csv("inputs/tazcentroids.csv") %>%
  arrange(TAZID) %>%
  filter(CO_FIPS > 0) %>%
  mutate(TAZ = as.character(TAZID))
```


### New Household Coordinates
Since there is no knowledge of the household location behond the TAZ in which they are located, a random parcel location within the same TAZ is assigned to each household. Many times, the same parcel id is used amoung multiple household ids. 

#### Parcel Id Coordinates
In order to accomplish the task of assigning households parcel id coordinates, first the total number of households in each TAZ must be determined.

```{r}
#determine the total number of households per TAZ
tothh <-house %>%
  arrange(TAZ) %>% mutate(tot_hh = 1) %>% select(TAZ, tot_hh)%>%
  group_by(TAZ) %>% summarize_all("sum")
p <- data.frame(TAZ = (1:2881))  

#display TAZs with no households as the value of 0
tothh <- left_join(p, tothh, by = "TAZ") 
tothh[is.na(tothh)] <- 0
```

Then, by spliting up the parcel table into separate vectors for each TAZ, and using a loop, a set of coordinates for the right amount of households per TAZ can be determined.The separted vectors with added coordinates are then joined into a table.

```{r}
#separate the parcel data table into a set of vectors for each TAZ
parcel <- parcel %>% arrange(TAZ) %>% select(TAZ, xcoord, ycoord)
splitt <- split(parcel,parcel$TAZ)

#a loop that determines the coordinates for each TAZ based on the number of households per TAZ; use of the sample function; a joint table is continually updated
i = 1
while (i <= 2881){
  n = tothh[i,2]
  testsam <- sample_n(splitt[[i]], n, replace = TRUE)
  ifelse(i == 1, join <- sample_n(splitt[[1]], n, replace = TRUE),   join <- rbind(join, testsam))
  i = i + 1
}
colnames(join)[2] <- "longitude"
colnames(join)[3] <- "latitude"
```

A table of randomly selected parcel id coordinates has been created, based on the correct amount of values needed for the households

#### Joining Tables
In order to combine the parcel coordinates dataset created in the previous step with the household dataset, a lot of memory is required. For some reason, by turning the TAZ values into a string and joining them based on their index, it easier to merge the two tables. 

```{r table organization}
#organize the household dataset by numbering each TAZ for each household using Index
house2 <- house %>%
  arrange(TAZ) %>% 
  mutate(TAZ = as.character(TAZ)) %>% group_by(TAZ) %>%
  mutate(Index = 1:n(), index = as.character(Index), tazcom = paste(TAZ, index)) %>%
  select(tazcom, index, household_id)

#organize the parcel dataset by numbering each TAZ for each parcel using Index
parcel2 <- join %>%
  mutate(TAZ = as.character(TAZ)) %>% group_by(TAZ) %>%
  mutate(Index = 1:n(), index = as.character(Index), tazcom = paste(TAZ, index)) %>%
  select(tazcom, longitude, latitude)
```

#### Household Coordinates Table
The table below shows the final result of the household coordinates in longitude and latitude. It is a joint table of the updated parcel id coordinates and the house data table.

```{r}
#join the parcel and house tables by the indexing of the TAZ, thus assigning coordinates to the households
hhcoord <- left_join(house2, parcel2, by = "tazcom") %>% select(TAZ.x, household_id, longitude, latitude)
  colnames(hhcoord)[1] <- "TAZ"
  
#display the final table of the household coordinates and create a csv
paged_table(hhcoord)
write_csv(hhcoord, "hhcoord.csv")
```

### Map Comparison
Using the WFRC GIS TAZ file, we can display the poloygon of any TAZ we want on a map. Then, we can compare two maps: one with the position of the households before assigning parcel coordinates and one after assigning the parcel coordinates. 

First we pick the TAZ we want to compare, as long as it exists within the sythetic population data. Most numbers under 2869 will work. 

Some good TAZ ids: 14-water,123-distribution, 141-large taz, 2445-lots of hhs, 1231-taz centroid overused

```{r taz pick}
#pick the wanted taz id
tazid <- "14"

#if a random taz is wanted
#tazid <- as.character(floor(runif(1, min=0, max=2869)))
#print(tazid)
```

#### TAZ Map Features
Next we read in the TAZ GIS file and its centroid, the updated position of the old households.
```{r old coord}
#read in the gis file for the taz polygons
taz <- st_read("inputs/taz.geojson") %>% 
  mutate(TAZ = as.character(TAZID)) %>%
  filter(CO_FIPS > 0) %>%
  filter(TAZ == tazid) %>%
  select(TAZ)

#store the coordinates of the taz centroid based households
hhcoord1 <- left_join(hhcoord, tazcent, by = "TAZ")
tazc <- hhcoord1 %>%
  filter(TAZ == tazid) %>%
  select(TAZ, household_id, xcoord, ycoord)
colnames(tazc)[3] = ("longitude")
colnames(tazc)[4] = ("latitude")
```

#### Household Map Features
Then, using the new household coordinate table, we get the coordinates of the new household positions.
```{r new coord}
#get coordinates for households
parcelc <- hhcoord %>%
  filter(TAZ == tazid) %>%
  select(TAZ,household_id, longitude, latitude)
```

#### Maps Displayed
Finally, a comparison map can be seen. The left showing the household coordinates before this analysis, and the right showing the position of the households after this analysis.The positioning of the new coordinates for the households are clearly in more reasonable spots. Also, the table below each map shows the exact coordinates of each household.

```{r tazmap}
#this map shows the taz polygon and its centroid
map1 <- leaflet() %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(data = taz, group = "TAZ") %>%
  addCircleMarkers(data = tazc, group = "TAZC") %>%
  addLayersControl(overlayGroups = c("TAZ", "TAZC"))

#this map shows the household's new coordinates
map2 <- leaflet() %>%
  addProviderTiles(providers$Esri.WorldGrayCanvas) %>%
  addPolygons(data = taz, group = "TAZ") %>%
  addCircleMarkers(data = parcelc, group = "PARCELC") %>%
  addLayersControl(overlayGroups = c("TAZ","PARCELC"))

#show the maps synchronized
sync(map1,map2)
```

```{r table, echo = FALSE}
#display the table side by side
kable(tazc) %>%
  kable_styling(full_width = FALSE, position = "float_left")
kable(parcelc) %>%
  kable_styling(full_width = FALSE, position = "right")
```
