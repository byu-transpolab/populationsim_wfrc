---
title: "SE Data"
author: "Chris Day"
date: "5/14/2020"
output: html_document
---

```{r, message=FALSE, warning=FALSE}
library(rmarkdown)
library(tidyverse)
library(plyr)
library(dplyr)
```


***
## Introduction
The ActivitySim Model requires an input of specific socioeconomic (SE) data for certain counties in the Wasatch Front (Weber, Davis, Salt Lake, Utah). This document explains what data is needed, where the data comes from, and how the data is changed into the correct format in order to be processed.

The socioeconomic file needs 42 different inputs that can be described as different column headings. The headings are the following:  

> ##### ZONE, DISTRICT, SD, COUNTY, TOTHH, HHPOP, TOTPOP, EMPRES, SFDU, MFDU, HHINCQ1, HHINCQ2, HHINCQ3, HHINCQ4, TOTACRE, RESACRE, CIACRE, SHPOP62P, TOTEMP, AGE0004, AGE2044, AGE4564, AGE65P, RETEMPN, FPSEMPN, HEREMPN, OTHEMPN, AGREMPN, MWTEMPN, PRKCST, OPRKCST, area_type, HSENROLL, COLLFTE, COLLPTE, TOPOLOGY, TERMINAL, ZERO, hhlds, sftaz, gqpop

The describtion for each column heading can be found at this link: https://github.com/BayAreaMetro/modeling-website/wiki/TazData

Also, in order to put together all 46 columns of input data, the data must be collected from various sources.

```{r}
#wfrc data
SEWF18 <- read.csv("inputs/SE_WF_2018.csv")
  colnames(SEWF18)[1] <- "ZONE"
  
#synpop expanded household ids
exhouse = read.csv("inputs/synpop/expanded_household_ids.csv")
  colnames(exhouse)[3] <- "ZONE"
  
#synpop household data
hsyn = read.csv("inputs/synpop/synthetic_households.csv")
  colnames(hsyn)[4] <- "ZONE"
  
#synpop population data
psyn = read.csv("inputs/synpop/synthetic_persons.csv")
  colnames(psyn)[3] <- "ZONE"

```


***
### ZONE
The Zone data is a list of all the TAZs. This list is copied from the 2018 SE data from WFRC. <!-- Should I put this file somewhere in populationsim_wfrc? That way I can access it? Maybe inputs folder? The 2020 one is there. For now its in the inputs folder on my computer.--> A lot of other data come from this file as well.

```{r, layout = "1-body-outset", message=FALSE, warning=FALSE}
#create a variable to hold the TAZ/Zone column
TAZ <- SEWF18 %>%
  select(ZONE)
```


***
### DISTRICT, SD, COUNTY
The District and County information is determined by the PUMA. The following table shows this relationship. 

```{r}
#display the district/county key
dckey = read.csv("inputs/other/DC_Key.csv")
paged_table(dckey)
```

The synthetic population data shows the PUMA of each specific ZONE. 

```{r}
#create a table of PUMA and ZONE from the exhouse variable
d1 = exhouse %>%
  group_by(PUMA, ZONE) %>%
  summarize_all("sum") %>%
  arrange(ZONE) %>%
  select(PUMA,ZONE)

#create a table holding the District, SD, and County info, sorted by their ZONE
d2 <- (merge(d1, dckey, by = "PUMA"))
DSC = d2 %>%
  mutate(SD = DISTRICT)%>%
  select(ZONE, DISTRICT, SD, COUNTY)

#update full table
FullTable <- merge(TAZ, DSC, by = "ZONE", all = TRUE)
```


***
### TOTHH, HHPOP, TOTPOP
The total household (TOTHH) and total population (TOTPOP) data comes from the 2018 WFRC SE data. Household population (HHPOP) is a funciton of household size (HHSIZE) which is also found in the same data set. 

```{r}
#create a table of the household and total population data from the wfrc data
HH <- SEWF18 %>%
  mutate(HHPOP = TOTHH * HHSIZE) %>%
  select(ZONE, TOTHH, HHPOP, TOTPOP)

#update full table
FullTable <- merge(FullTable, HH, by = 'ZONE', all = TRUE)
```


***
### EMPRES


***
### SFDU, MFDU


***
### HHINCQ1,	HHINCQ2,	HHINCQ3,	HHINCQ4
The income data is separated into 4 variables, each representing a different range of household income per year. This data is extracted from the synthetic population household data. That houehold data shows income to a factor of 10^6, so that is taken into account.  

```{r}
#create a table with columns representing the household income for each category
#assign the value of 1 if the criteria for the column is met
HouseIncome <- hsyn %>%
  mutate(
    inc = HHINCADJ/(10^6),
    money = ifelse(inc < 30000, 1, ifelse(inc >= 30000 & inc < 60000, 2, 
            ifelse(inc >= 60000 & inc < 100000, 3, 4))),
    HHINCQ1 = ifelse(money == 1, 1, 0),
    HHINCQ2 = ifelse(money == 2, 1, 0),
    HHINCQ3 = ifelse(money == 3, 1, 0),
    HHINCQ4 = ifelse(money == 4, 1, 0)
   ) %>%
  select(ZONE, HHINCQ1, HHINCQ2, HHINCQ3, HHINCQ4) %>%
  
  #group the data by ZONE and sum all the values to get the total counts for each ZONE
  group_by(ZONE) %>%
  summarize_all("sum")

#update full table
FullTable <- merge(FullTable, HouseIncome, by = 'ZONE', all = TRUE)
```

***
### TOTACRE,	RESACRE,	CIACRE


***
### TOTEMP
The data for the TOTEMP category is a copy of the ALLEMP column from the 2018 WFRC Data. 

```{r}
#create a variable to hold the Total employment column
Temp <- SEWF18 %>%
  select(ZONE, ALLEMP)
```


***
### AGES: AGE0004,	AGE0519,	AGE2044,	AGE4564,	AGE65P
The data for the age grouping columns are determined from the persons/population table within the synthetic population data. 

```{r}
#create a table that has 5 columns that store the value of 1 for the matched age criteria
AgeGroups <- psyn %>%
  mutate(
    AGE = ifelse(AGEP %in% 0:4, 1, ifelse(AGEP %in% 5:19,2,
          ifelse(AGEP %in% 20:44, 3, ifelse(AGEP %in% 45:64, 4, 5)))),
    AGE2 = ifelse(AGEP >= 62, 1, 0),
    AGE0004 = ifelse(AGE == 1, 1,0),
    AGE0519 = ifelse(AGE == 2, 1,0),
    AGE2044 = ifelse(AGE == 3, 1,0),
    AGE4564 = ifelse(AGE == 4, 1,0),
    AGE65P = ifelse(AGE == 5, 1,0),
    AGE62P = ifelse(AGE2 == 1, 1,0)
  )
 
#select the write columns, group the data by Zone, and sum all the values to get the total counts for each Zone
ages <- AgeGroups %>% 
  select(ZONE, AGE0004, AGE0519, AGE2044, AGE4564, AGE65P, AGE62P) %>%
  group_by(ZONE) %>%
  summarize_all("sum")

#create a table for certain age groups
age1 <- ages %>%
  select(ZONE, AGE0004, AGE0519, AGE2044, AGE4564, AGE65P)
```


***
### SHPOP62+
The SHPOP62P category is determined from the persons data as well. It takes into account the total population, which is determined by the sum of all the age groups instead of by the TOTPOP field. 
```{r}
#create a table for the 62+ age group info
age2 <- ages %>%
  mutate(
    SHPOP62P = AGE62P/(AGE0004+AGE0519+AGE2044+AGE4564+AGE65P)
  )%>%
  select(ZONE, SHPOP62P)
```


```{r}
#update full table in the correct table order
FullTable <- merge(FullTable, age2, by = 'ZONE', all = TRUE)
FullTable <- merge(FullTable, Temp, by = 'ZONE', all = TRUE)
FullTable <- merge(FullTable, age1, by = 'ZONE', all = TRUE)
#paged_table(FullTable)
```


***
### EMPLOYMENT: RETEMPN	FPSEMPN	HEREMPN	OTHEMPN	AGREMPN	MWTEMPN




***
## Final Table
The final table is the combination of all 46 column headers, organized primarily by the socioeconomic data from the WFRC 2018 file. This table will be used as an input for the ActivitySim model. 

```{r}
#create a table holding all 46 column values needed, organized primarily by the socioeconomic data from WFRC
#FullTable <- merge(FullTable, "final column", by = 'ZONE', all = TRUE)
#paged_table(FullTable)
```
