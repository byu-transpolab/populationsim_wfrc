---
title: "SE Data"
author: "Chris Day"
date: "5/14/2020"
output: html_document
---

```{r, message=FALSE, warning=FALSE}
library(rmarkdown)
library(tidyverse)
library(plyr)
library(dplyr)
library(knitr)
```

***
## Introduction
The ActivitySim Model requires an input of specific socioeconomic (SE) data for certain counties in the Wasatch Front (Weber, Davis, Salt Lake, Utah). This document explains what data is needed, where the data comes from, and how the data is changed into the correct format in order to be processed.

The socioeconomic file requires 42 different inputs which can be described as different column headings. These headings are copied directly from the ActivitySim Example's input file. The headings are the following:  

> ##### ZONE, DISTRICT, SD, COUNTY, TOTHH, HHPOP, TOTPOP, EMPRES, SFDU, MFDU, HHINCQ1, HHINCQ2, HHINCQ3, HHINCQ4, TOTACRE, RESACRE, CIACRE, SHPOP62P, TOTEMP, AGE0004, AGE0519, AGE2044, AGE4564, AGE65P, RETEMPN, FPSEMPN, HEREMPN, OTHEMPN, AGREMPN, MWTEMPN, PRKCST, OPRKCST, area_type, HSENROLL, COLLFTE, COLLPTE, TOPOLOGY, TERMINAL, ZERO, hhlds, sftaz, gqpop

The describtion for each column heading can be found at this link: https://github.com/BayAreaMetro/modeling-website/wiki/TazData

Also, in order to put together all 42 columns of input data, the data must be collected from various sources. The data sources are as follows: the 2018 SE WFRC data file, the synthetic population files, the buildings and parcel datasets from WFRC,  urbanization data from WFRC and the TAZ shapefile, topology data from the AGRC website and the TAZ shapefile, and . <!-- other files here-->. 

```{r, message=FALSE, warning=FALSE}
#wfrc socioeconomic data
SEWF18 <- read_csv("inputs/SE_WF_2018.csv")
  colnames(SEWF18)[1] <- "ZONE"
  
#synpop expanded household ids
exhouse = read_csv("inputs/synpop/expanded_household_ids.csv", 
          col_types = list(PUMA = col_integer(), TAZ = col_integer()))
  colnames(exhouse)[3] <- "ZONE"
  
#synpop household data
hsyn = read_csv("inputs/synpop/synthetic_households.csv")
  colnames(hsyn)[4] <- "ZONE"
  
#synpop population/persons data
psyn = read_csv("inputs/synpop/synthetic_persons.csv")
  colnames(psyn)[3] <- "ZONE"
  
#buildings data from WFRC
buildings <- read_csv("inputs/other/buildings.csv")

#parcel data from WFRC
parcels <- read_csv("inputs/other/parcels.csv")
  colnames(parcels)[2] <- "ZONE"

#TAZ shapefile & urbanization data from WFRC
urban <- read_csv("inputs/other/urbanization.csv", 
         col_types = list(Z = col_integer(), ATYPE = col_integer()))
  colnames(urban)[2] <- "ZONE"

#topology data using TAZ shapefie  
topo <- read_csv("inputs/other/topology.csv")
```


***
### ZONE
The Zone data is a list of all the TAZs. This list is copied from the 2018 SE data from WFRC. A lot of other data comes from this file as well.

```{r, layout = "1-body-outset", message=FALSE, warning=FALSE}
#create a variable to hold the TAZ/Zone column
TAZ <- SEWF18 %>%
  select(ZONE)
```

Note:
The synthetic population data has a less total number TAZs than the 2018 SE WFRC data (it is off by a few hundred). The final table created is grouped by the TAZs in the SE WFRC data. Therefore, columns from the synthetic population data will have missing fields scattered throughout the final table. <!-- How should I fill in this data? --> 


***
### DISTRICT, SD, COUNTY
The District and County information is determined by the PUMA. The following table shows this relationship. 

```{r, message=FALSE}
#display the district/county key that I made up
dckey = read_csv("inputs/other/DC_Key.csv")
paged_table(dckey)
```

The synthetic population data shows the PUMA of each specific zone. Using this data, and the key above, the districts and counties are determined.  

```{r}
#create a table of PUMA and ZONE from the exhouse variable
d1 = exhouse %>%
  group_by(PUMA, ZONE) %>%
  summarize_all("sum") %>%
  arrange(ZONE) %>%
  select(PUMA,ZONE)

#create a table holding the District, SD, and County info, sorted by their ZONE
d2 <- (merge(d1, dckey, by = "PUMA"))
DSC = d2 %>%
  mutate(SD = DISTRICT)%>%
  select(ZONE, DISTRICT, SD, COUNTY)

#update full table
FullTable <- merge(TAZ, DSC, by = "ZONE", all = TRUE)
```

***
### TOTHH, HHPOP, TOTPOP
The total household (TOTHH) and total population (TOTPOP) data comes from the 2018 SE WFRC data. Household population (HHPOP) is a funciton of household size (HHSIZE) which is also found in the same data set. 

```{r}
#create a table of the household and total population data from the wfrc data
HH <- SEWF18 %>%
  mutate(HHPOP = TOTHH * HHSIZE) %>%
  select(ZONE, TOTHH, HHPOP, TOTPOP)

#update full table
FullTable <- merge(FullTable, HH, by = 'ZONE', all = TRUE)
```


***
### EMPRES
The number of employed residents is determined by the data in the synthetic population persons file. If the COW (class of worker) categoty isn't empty, the person is assumed to be employed. 

```{r}
#create a table that determines the number of employed residents in each ZONE
workerbee <- psyn %>%
  mutate(
    EMPRES = ifelse(COW %in% 1:9, 1, 0)
  ) %>%
  select(ZONE, EMPRES) %>%
  group_by(ZONE) %>%
  summarize_all("sum")

#update full table
FullTable <- merge(FullTable, workerbee, by = 'ZONE', all = TRUE)
```


***
### SFDU, MFDU
To find data on single family and multi family dwelling units, data from the buildings and parcel datasets from WFRC must be used. To interpret the building type from the buildings dataset the following key can be used as well.

| building_type_id | Building Type                          |
| ---------------- | -------------------------------------- |
| 1                | Single Family Residential              |
| 2                | Multi Family Residential               |
| 3                | Industrial, Warehouse, & Storage       |
| 4                | Retail                                 |
| 5                | Office                                 |
| 6                | Government & Education                 |
| 7                | Mixed Use                              |
| 8                | Other                                  |

We only want the single family and multi family information from the buildings file. 
```{r}
#merge tables by parcel id to compare buildings data with the Zone
units <- merge(buildings, parcels, by = 'parcel_id')
#create a table that determines the number of single and multi family units in each Zone
dwell <- units %>%
  mutate(
    SFDU = ifelse(building_type_id == 1, residential_units, 0),
    MFDU = ifelse(building_type_id == 2, residential_units, 0)
  ) %>% 
  select(ZONE, SFDU, MFDU) %>%
  group_by(ZONE) %>%
  summarize_all("sum")

#update full table
FullTable <- merge(FullTable, dwell, by = 'ZONE', all = TRUE)
```


***
### Income: HHINCQ1,	HHINCQ2,	HHINCQ3,	HHINCQ4
The income data is separated into 4 variables, each representing a different range of household income per year. This data is extracted from the synthetic population household data. That household data shows income to the factor of 10^6, so that is taken into account.  

```{r}
#create a table with columns representing the household income for each category
#assign the value of 1 if the criteria for the column is met
HouseIncome <- hsyn %>%
  mutate(
    inc = HHINCADJ/(10^6),
    money = ifelse(inc < 30000, 1, ifelse(inc >= 30000 & inc < 60000, 2, 
            ifelse(inc >= 60000 & inc < 100000, 3, 4))),
    HHINCQ1 = ifelse(money == 1, 1, 0),
    HHINCQ2 = ifelse(money == 2, 1, 0),
    HHINCQ3 = ifelse(money == 3, 1, 0),
    HHINCQ4 = ifelse(money == 4, 1, 0)
   ) %>%
  select(ZONE, HHINCQ1, HHINCQ2, HHINCQ3, HHINCQ4) %>%
  
  #group the data by ZONE and sum all the values to get the total counts for each ZONE
  group_by(ZONE) %>%
  summarize_all("sum")

#update full table
FullTable <- merge(FullTable, HouseIncome, by = 'ZONE', all = TRUE)
```


***
### TOTACRE,	RESACRE,	CIACRE
The acre data comes from the buildings, parcels, and TAZ shapefile/urbanization data from WFRC. The total number of acres comes from the urbanization file. Other than the total number of acres, the urbanization file only had a "Developed Acres" field, which is not specific enough to use for the residential and commercial acres fields. Therefore, calculations using the parcels and buildings data was used to get an estimate of the residential and commercial number of acres.

```{r}
#extract the total number of acres per Zone from the urban file.
colnames(urban)[5] = "TOTACRE"
totacre <- urban %>%
  select(ZONE, TOTACRE)

#update full table
FullTable <- merge(FullTable, totacre, by = 'ZONE', all = TRUE)
```

```{r}
# merge tables by parcel id to compare buildings data with the Zone
unit <- merge(buildings, parcels, by = 'parcel_id')
# create a table that sums up the residedntial and commercial acres in each Zone
acres <- unit %>%
  mutate(
    RESACRE = ifelse(building_type_id == 1, parcel_acres, 
                ifelse(building_type_id == 2, parcel_acres, 0)),
    CIACRE = ifelse(building_type_id == 3, parcel_acres, 
                ifelse(building_type_id == 4, parcel_acres, 
                ifelse(building_type_id == 5, parcel_acres, 0)))
  ) %>% 
  select(ZONE, RESACRE, CIACRE)%>%
  group_by(ZONE) %>%
  summarize_all("sum")

#update full table
FullTable <- merge(FullTable, acres, by = 'ZONE', all = TRUE)
```


***
### TOTEMP
The data for the TOTEMP category is a copy of the ALLEMP column from the 2018 SE WFRC Data. 

```{r}
#create a variable to hold the Total employment column
Temp <- SEWF18 %>%
  select(ZONE, ALLEMP)
```


***
### AGES: AGE0004,	AGE0519,	AGE2044,	AGE4564,	AGE65P
The data for the age grouping columns are determined from the persons/population table within the synthetic population data. 

```{r}
#create a table that has 5 columns that store the value of 1 for the matched age criteria
AgeGroups <- psyn %>%
  mutate(
    AGE = ifelse(AGEP %in% 0:4, 1, ifelse(AGEP %in% 5:19,2,
          ifelse(AGEP %in% 20:44, 3, ifelse(AGEP %in% 45:64, 4, 5)))),
    AGE2 = ifelse(AGEP >= 62, 1, 0),
    AGE0004 = ifelse(AGE == 1, 1,0),
    AGE0519 = ifelse(AGE == 2, 1,0),
    AGE2044 = ifelse(AGE == 3, 1,0),
    AGE4564 = ifelse(AGE == 4, 1,0),
    AGE65P = ifelse(AGE == 5, 1,0),
    AGE62P = ifelse(AGE2 == 1, 1,0)
  )
 
#select the right columns, group the data by Zone, and sum all the values to get the total counts for each Zone
ages <- AgeGroups %>% 
  select(ZONE, AGE0004, AGE0519, AGE2044, AGE4564, AGE65P, AGE62P) %>%
  group_by(ZONE) %>%
  summarize_all("sum")

#create a table for certain age groups
age1 <- ages %>%
  select(ZONE, AGE0004, AGE0519, AGE2044, AGE4564, AGE65P)
```


***
### SHPOP62+
The SHPOP62P category is determined from the sythetic popoulation persons data as well. It takes into account the total population, which is determined by summing up all of the age groups instead of using the TOTPOP field. 
```{r}
#create a table for the 62+ age group data
age2 <- ages %>%
  mutate(
    SHPOP62P = AGE62P/(AGE0004+AGE0519+AGE2044+AGE4564+AGE65P)
  )%>%
  select(ZONE, SHPOP62P)
```


```{r}
#update full table in the correct table order
FullTable <- merge(FullTable, age2, by = 'ZONE', all = TRUE)
FullTable <- merge(FullTable, Temp, by = 'ZONE', all = TRUE)
FullTable <- merge(FullTable, age1, by = 'ZONE', all = TRUE)
```


***
### EMPLOYMENT: RETEMPN,	FPSEMPN,	HEREMPN,	OTHEMPN,	AGREMPN,	MWTEMPN
The employment data comes from using the 2018 SE WFRC data file. It is not a direct copy of the columns. To relate the columns, we need to understand the meaning of the employment columns from WFRC. The meaning of the headings are shown below: 

```{r, message=FALSE}
#display the employment key from wfrc
empkey = read_csv("inputs/other/EMP_Key.csv")
kable(empkey)
```

The code explains how the required employment data is calculated. (Note: construction is assumed to be a professional service in the calculation).

```{r}
#create a table with new employment columns, based on the WFRC ones
#select the ones we want to use
Employment <- SEWF18 %>%
  mutate(
    RETEMPN = RETL + FOOD,
    FRSEMPN = OFFI + FM_CONS,
    HEREMPN = HLTH + GVED,
    OTHEMPN = OTHR + HBJ,
    AGREMPN = FM_AGRI + FM_MING,
    MWTEMPN = MANU + WSLE
  ) %>%
  select(ZONE, RETEMPN, FRSEMPN, HEREMPN, OTHEMPN, AGREMPN, MWTEMPN)

#update full table
FullTable <- merge(FullTable, Employment, by = 'ZONE', all = TRUE)
```


***
### PRKCST, OPRKCST
Long term (PRKCST) and short term (OPRKCST) parking rates are found in the WFRC urbanization data file. Techinaclly the long term parking field needed is for parking of 8 hours or more, but we will use permanent parking rates from the urbanization file instead. We will use temporary parking rates for the short term parking field as well. 

```{r}
#create a table with new parking rates (in cents)
parking <- urban %>%
  mutate(
    PRKCST = PRKCSTPERM * 100,
    OPRKCST = PRKCSTTEMP * 100
  ) %>%
  select(ZONE, PRKCST, OPRKCST)
  
#update full table
FullTable <- merge(FullTable, parking, by = 'ZONE', all = TRUE)
```


***
### area_type
The area type of each Zone is described on the website from the introduction and is found from the WFRC urbanization data. 

```{r}
#select the area type column variable from the urbanization file
colnames(urban)[15] = "area_type"
area <- urban %>%
  select(ZONE, area_type)

#update full table
FullTable <- merge(FullTable, area, by = 'ZONE', all = TRUE)
```


***
### HSENROLL
The highschool enrollment data is copied from the 2018 SE WFRC data. 

```{r}
#create a variable to hold the high school column
HS <- SEWF18 %>%
  select(ZONE, Enrol_High)

#update full table
FullTable <- merge(FullTable, HS, by = 'ZONE', all = TRUE)
```


***
### COLLFTE, COLLPTE


***
### TOPOLOGY
Utah topology information comes from the AGRC website. Elevations for each Zone was found by joining the utah elevation shapefile, located on the website, with the TAZ shapefile within QGIS. 

https://gis.utah.gov/data/elevation-and-terrain/contours/

Then elevation groups can be determined by using the chart below:  

| Elevation Range (ft) | Topology/Steepness |
| -------------------- | ------------------ |
| < 5000               | 1 - Flat           |
| 5000 - 5999          | 2 - In Between     |
| > 6000               | 3 - Steep          |

Note: Elevation may not be the best way to measure steepness, but it will work for a good estimation.

```{r}
#select the topology information
steepy <- topo %>%
  mutate(
    TOPOLOGY = ifelse(ContourEle < 5000, 1, ifelse(ContourEle < 6000, 2, 3))
  ) %>%
  select(ZONE, TOPOLOGY)

#update full table
FullTable <- merge(FullTable, steepy, by = 'ZONE', all = TRUE)
```


***
### TERMINAL
The terminal time for each zone is an estimate taken from WFRC. (We are using their estimations instead of making up our own). Most of them are between 1 and 2 minutes., as many of the TAZs are roughly a similar size in area.  

```{r}
# create a variable to hold the terminal information from the urbanization file
colnames(urban)[16] = "TERMINAL"
term <- urban %>%
  select(ZONE, TERMINAL)

#update full table
FullTable <- merge(FullTable, term, by = 'ZONE', all = TRUE)
```


***
### Other: ZERO, hhlds, sftaz, gqpop
The last columns needed for the input columns are either repeats or easy to calculate.

```{r}
#create a table to hold the remaining columns after calculating them
Other <- SEWF18 %>%
  mutate(
    ZERO = 0,
    hhlds = TOTHH,
    sftaz = ZONE,
    gqpop = TOTPOP - (TOTHH * HHSIZE)
  ) %>%
  select(ZONE, ZERO, hhlds, sftaz, gqpop)
```


***
## Final Table
The final table is the combination of all 42 column headers (described above), organized primarily by the socioeconomic data from the 2018 WFRC file. This table will be used as one of the primary inputs for the ActivitySim model. 

```{r}
#create a table holding all 42 column values needed, organized primarily by the socioeconomic data from WFRC
FullTable <- merge(FullTable, Other, by = 'ZONE', all = TRUE)
paged_table(FullTable)
```
