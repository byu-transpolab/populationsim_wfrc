---
title: "Popsim Validation"
author: "Christian Hunter"
date: "4/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(sf)
library(leaflet)
library(tidyverse)
library(tigris)
library(tidycensus)
options(readr.show_progress = FALSE)
```

## Error Map

The synthetic population created using PopultionSim and the WFRC model has a slight discrepancy between in the household controls at the tract level. The controls for total households are at the TAZ level while the controls for household size (1 person, 2 people, etc.) are at the census tract level. During the creation of the synthetic population, PopulationSim creates a total household control at the tract level that is greater than the sum of the individual household size controls. To see if there was any geographic trend in this error, a map of the difference between these two values was created.


```{r hh_error}
tract_sum <- read_csv("output/summary_TRACT.csv")
hherror <- tract_sum %>% 
  select(1:7)
hherror$err <- (tract_sum$num_hh_control - tract_sum$hh_size_1_control - tract_sum$hh_size_2_control
                            - tract_sum$hh_size_3_control - tract_sum$hh_size_4_plus_control)

#Import tract data
tr <- tracts("UT", county = unique(substr(puma_tract$TRACT, 3, 5)), 
             class = "sf", progress_bar = FALSE) %>%
  st_transform(4326)

tr$GEOID <- as.numeric(as.character(tr$GEOID))  
  
tr <- tr %>% 
  left_join(hherror, by = c("GEOID" = "id"))

#Map
st_write(tr, "validation/error.shp")
```

## Person Categories
Compare the population breakdown to the NHTS data

```{r}
replace_na <- function(x) {
  ifelse(is.na(x),-8,x)
}

people <- read_csv("output/synthetic_persons.csv")

people <- people %>% 
  mutate_at(.vars = vars(COW, WKHP), replace_na) %>% 
  mutate(
    DIS_status = case_when(
      DIS == "1" ~ T,
      TRUE ~ F
    ),
    amb_dif_status = case_when(
      DPHY == "1" ~ T,
      TRUE ~ F
    ),
    PT_hours = case_when(
      WKHP > 0 & WKHP < 40 ~ T,
      TRUE ~ F
    ),
    FT_hours = case_when(
      between(WKHP, 40, 99) ~ T,
      TRUE ~ F
    ), 
    worker = case_when(
      PT_hours == TRUE ~ T,
      FT_hours == T ~ T,
      T ~ F
    ),
    
    person_type = case_when(
      DIS_status == T & worker == T ~ "WW",
      DIS_status == T & worker == F ~ "WN",
      #Use ambulatory difficulty instead of disability to see which matches better with wheelchair population
      amb_dif_status == T & worker == T ~ "ADW",
      amb_dif_status == T & worker == F ~ "ADN",
      FT_hours == T ~ "FW",
      PT_hours == T ~ "PW",
      COW == "9" & AGEP >= 50 ~ "RT", 
      worker == F & AGEP >= 18 ~ "NW",
      AGEP < 18 & AGEP >= 16 ~ "SD",
      AGEP < 16 & AGEP >= 5  ~ "SP",
      AGEP >= 0 & AGEP < 5 ~ "PS"
    ),
    person_type = fct_relevel(person_type, 
                              "FW", "PW", "NW", "RT", 
                              "SD", "SP", "PS", "WW", "WN", "ADW", "ADN")
  )

```
