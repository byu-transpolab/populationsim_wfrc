---
title: "Popsim Validation"
author: "Christian Hunter"
date: "4/1/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(sf)
library(leaflet)
library(tidyverse)
library(tigris)
library(tidycensus)
library(memisc)
options(readr.show_progress = FALSE)
```

## Error Map

The synthetic population created using PopultionSim and the WFRC model has a slight discrepancy between in the household controls at the tract level. The controls for total households are at the TAZ level while the controls for household size (1 person, 2 people, etc.) are at the census tract level. During the creation of the synthetic population, PopulationSim creates a total household control at the tract level that is greater than the sum of the individual household size controls. To see if there was any geographic trend in this error, a map of the difference between these two values was created.


```{r hh_error}
tract_sum <- read_csv("output/summary_TRACT.csv")
hherror <- tract_sum %>% 
  select(1:7)
hherror$err <- (tract_sum$num_hh_control - tract_sum$hh_size_1_control - tract_sum$hh_size_2_control
                            - tract_sum$hh_size_3_control - tract_sum$hh_size_4_plus_control)

#Import tract data
tr <- tracts("UT", county = unique(substr(puma_tract$TRACT, 3, 5)), 
             class = "sf", progress_bar = FALSE) %>%
  st_transform(4326)

tr$GEOID <- as.numeric(as.character(tr$GEOID))  
  
trmap <- tr %>% 
  left_join(hherror, by = c("GEOID" = "id"))

#Map
st_write(trmap, "validation/error.shp")

#Comparison of control households
trhh <- tr %>% 
  left_join(tract_sum, by = c("GEOID" = "id"))
aggregate(trhh$num_hh_control, by=list(Category=trhh$COUNTYFP), FUN=sum, na.rm = TRUE)

tazhh <- read_csv("output/summary_TAZ.csv") 
sum(tazhh$num_hh_control)

#As shown here, the tract controls generated by PopulationSim match the total households in the WFRC TAZ controls
```

## The TAZ-level outputs also are compared to WFRC simulated demographics

```{r taz_comparison}
hh_data <- read_csv("output/synthetic_households.csv")
per_data <- read_csv("output/synthetic_persons.csv")
wfrc_size <- read_csv('validation/hhsize_wfrc.csv') 
wfrc_inc <- read_csv('validation/hhinc_wfrc.csv')
wfrc_work <- read_csv('validation/hhworkers_wfrc.csv')

## Calculate distribution of hh size, income, and workers
ps_size <- hh_data %>% 
  mutate(labels  = case_when(
  NP == 1 ~ "HH1",
  NP == 2 ~ "HH2",
  NP == 3 ~ "HH3",
  NP == 4 ~ "HH4",
  NP == 5 ~ "HH5",
  NP >= 6 ~ "HH6",
  TRUE ~ "NA"
  )) %>%
  group_by(TAZ, labels) %>% 
  tally() %>% 
  spread(labels, n)

ps_inc <- hh_data %>% 
  mutate(labels = case_when(
    HHINCADJ < 15000 ~ 'INC1',
    HHINCADJ < 30000 ~ 'INC2',
    HHINCADJ < 60000 ~ 'INC3',
    HHINCADJ >= 60000 ~ 'INC4'
  )) %>% 
  group_by(TAZ, labels) %>% 
  tally() %>% 
  spread(labels, n)

ps_work <- hh_data %>% 
  mutate(labels = case_when(
    WIF == 0 ~ 'WRK0',
    WIF == 1 ~ 'WRK1',
    WIF == 2 ~ 'WRK2',
    WIF == 3 ~ 'WRK3',
    WIF == 4 ~ 'WRK4',
    WIF == 5 ~ 'WRK5',
    WIF >= 6 ~ 'WRK6'
  )) %>% 
  group_by(TAZ, labels) %>% 
  tally() %>% 
  spread(labels, n)

## Left join WFRC to PS
comb_inc <- merge(x = ps_inc, y = wfrc_inc, by = 'TAZ')
comb_size <- merge(x = ps_size, y = wfrc_size, by = 'TAZ')
comb_work <- merge(x = ps_work, y = wfrc_work, by = 'TAZ')

## Replace NAs in PS columns with 0s
comb_inc[is.na(comb_inc)] <- 0
comb_size[is.na(comb_size)] <- 0
comb_work[is.na(comb_work)] <- 0

## Calculate difference (positive means greater in PS than in WFRC, vice versa for negative)
TAZ <- comb_inc$TAZ
diff_table <- data.frame(TAZ)
diff_table$INC1 <- comb_inc$INC1.x - comb_inc$INC1.y
diff_table$INC2 <- comb_inc$INC2.x - comb_inc$INC2.y
diff_table$INC3 <- comb_inc$INC3.x - comb_inc$INC3.y
diff_table$INC4 <- comb_inc$INC4.x - comb_inc$INC4.y
diff_table$HH1 <- comb_size$HH1.x - comb_size$HH1.y
diff_table$HH2 <- comb_size$HH2.x - comb_size$HH2.y
diff_table$HH3 <- comb_size$HH3.x - comb_size$HH3.y
diff_table$HH4 <- comb_size$HH4.x - comb_size$HH4.y
diff_table$HH5 <- comb_size$HH5.x - comb_size$HH5.y
diff_table$HH6 <- comb_size$HH6.x - comb_size$HH6.y
diff_table$WRK0 <- comb_work$WRK0.x - comb_work$WRK0.y
diff_table$WRK1 <- comb_work$WRK1.x - comb_work$WRK1.y
diff_table$WRK2 <- comb_work$WRK2.x - comb_work$WRK2.y
diff_table$WRK3 <- comb_work$WRK3.x - comb_work$WRK3.y

## Output to shapefile
taz_boundaries <- st_read("inputs/taz.geojson") %>% 
  mutate(TAZ = TAZID)
merge(x = diff_table, y = taz_boundaries[, c("TAZ", "geometry")], all.x = T)
error_map <- st_as_sf(taz_boundaries)
st_write(error_map, "validation/TAZerrormap.shp", driver = "ESRI Shapefile")
```

## Person Categories
Compare the population breakdown to the NHTS data

```{r cats}
replace_na <- function(x) {
  ifelse(is.na(x),-8,x)
}

people <- read_csv("output/synthetic_persons.csv")

people <- people %>% 
  mutate_at(.vars = vars(COW, WKHP, DDRS, DIS), replace_na) %>% 
  mutate(
    DIS_status = case_when(
      DDRS == "1" ~ T,
      TRUE ~ F
    ),
    PT_hours = case_when(
      WKHP > 0 & WKHP < 30 ~ T,
      TRUE ~ F
    ),
    FT_hours = case_when(
      between(WKHP, 30, 99) ~ T,
      TRUE ~ F
    ), 
    worker = case_when(
      PT_hours == TRUE ~ T,
      FT_hours == T ~ T,
      T ~ F
    ),
    
    person_type = case_when(
      DIS_status == T & worker == T ~ "WW",
      DIS_status == T & worker == F ~ "WN",
      FT_hours == T ~ "FW",
      PT_hours == T ~ "PW",
      COW == "9" & AGEP >= 50 ~ "RT", 
      worker == F & AGEP >= 18 ~ "NW",
      AGEP < 18 & AGEP >= 16 ~ "SD",
      AGEP < 16 & AGEP >= 5  ~ "SP",
      AGEP >= 0 & AGEP < 5 ~ "PS",
      T ~ "NONE"
    ),
    person_type = fct_relevel(person_type, 
                              "FW", "PW", "NW", "RT", 
                              "SD", "SP", "PS", "WW", "WN", "NONE")
  )

summary(people$person_type)
```


```{r demo}
#Nate's demographics code, not updated yet
total_persons <- read_rds("data/persons.rds") %>%
  filter(r_sex > 0, # cuts out 42
         hhfaminc > 0) %>% # cuts out 1187
  mutate(wd = ifelse(worker == "01", 1, 0),
         whd = ifelse(wrk_home == "01", 1, 0),
         male = ifelse(r_sex == "01", 1, 0),
         auto = ifelse(auto_own == "sufficient", 1, 0))
total_persons %>%
  group_by(person_type) %>%
  summarise(count = sum(wtperfin),
            av_age = mean(r_age),
            av_inc = mean(inc_cont),
            male = mean(male),
            employed = mean(wd),
            wrk_home = mean(whd),
            auto_sufficient = mean(auto)) %>%
  mutate(dist = percent(count/sum(count), accuracy = 0.1))
```

